name: Backend CI/CD Build â†’ ECR â†’ Update Manifests

on:
  push:
    branches: [ "main" ]

env:
  AWS_REGION: ${{ secrets.AWS_REGION }}
  AWS_ACCOUNT_ID: ${{ secrets.AWS_ACCOUNT_ID }}
  APP_NAME: backend
  MANIFESTS_PATH: apps/backend

jobs:
  build-deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Echo Workflow Start
      run: echo "ğŸš€ Starting Backend CI/CD Pipelineâ€¦"

    - name: Checkout backend repo
      uses: actions/checkout@v4

    - name: Debug Backend Repo Structure
      run: |
        echo "ğŸ“ Current backend repo directory:"
        pwd
        echo "ğŸ“„ Listing files:"
        ls -R .

    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v2
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ secrets.AWS_REGION }}

    - name: Login to Amazon ECR
      uses: aws-actions/amazon-ecr-login@v1

    - name: Set image variables
      id: vars
      run: |
        IMAGE="${AWS_ACCOUNT_ID}.dkr.ecr.${AWS_REGION}.amazonaws.com/${APP_NAME}:${GITHUB_SHA::7}"
        echo "IMAGE=$IMAGE" >> $GITHUB_ENV
        echo "ğŸ–¼  Docker image tag set to: $IMAGE"

    - name: Build Docker image
      run: |
        echo "ğŸ³ Building Docker imageâ€¦"
        docker build -t $IMAGE .
        echo "Docker build completed."

    - name: Push Docker image
      run: |
        echo "ğŸ“¤ Pushing image to ECRâ€¦"
        docker push $IMAGE
        echo "ECR push completed."

    - name: Clone manifests repo
      run: |
        echo "ğŸ“¥ Cloning k8s-manifests repoâ€¦"
        git clone "https://x-access-token:${{ secrets.MANIFESTS_REPO_TOKEN }}@github.com/sankarsv7/k8s-manifests.git" manifests
        echo "Clone complete."

    - name: Debug manifests repo
      run: |
        echo "ğŸ“ Listing cloned manifests repo:"
        ls -R manifests
        echo "ğŸ“Œ Verifying expected file:"
        ls manifests/${MANIFESTS_PATH}

    - name: Update image in manifests repo
      working-directory: manifests
      run: |
        echo "âœ Updating image in deployment fileâ€¦"
        FILE="${MANIFESTS_PATH}/deployment.yaml"

        echo "Looking for file: $FILE"
        ls -R .

        if [ ! -f "$FILE" ]; then
          echo "âŒ ERROR: File not found: $FILE"
          exit 1
        fi

        sed -i "s|IMAGE_PLACEHOLDER|${IMAGE}|" "$FILE"

        echo "ğŸ” Updated deployment.yaml:"
        cat "$FILE"

        git config user.email "github-actions@github.com"
        git config user.name "GitHub Actions"

        git add "$FILE"
        git commit -m "ci: update backend image â†’ ${IMAGE} [skip ci]" || echo "âš  No changes to commit"

        echo "ğŸ“¤ Pushing updated manifest back to repoâ€¦"
        git push origin HEAD:main

    - name: Done
      run: echo "ğŸ‰ Backend CI/CD completed successfully!"
